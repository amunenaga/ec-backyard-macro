@startuml picking_create_vba

skinparam monochrome true
skinparam packageFontSize 25

title ピッキングテンプレートVBA

database 社内DB

box "外部ファイル" #white
    entity CSV
    entity ｾｯﾄ商品ﾘｽﾄ.xls
end box

participant Main

[-> Main : マクロ起動
activate Main

note right
  <size:16>進捗表示ダイアログを実装</size>
end note

Main -> LoadCsv : Sub LoadCsv()
activate LoadCsv

LoadCsv -> LoadCsv : CSV指定\n日付チェック

CSV <- LoadCsv : データ接続

entity OrderSheet

LoadCsv -> OrderSheet : 受注データ取込
deactivate LoadCsv

Main -> DataValidate : FixForAddin() 社内DBと照合のためにコード修正
activate DataValidate
DataValidate -> OrderSheet : 照合用コード書込

participant SetParser

DataValidate -> SetParser : ○個組分解 Sub ParseScalingItem()

deactivate DataValidate

|||
activate SetParser

SetParser <- OrderSheet : ハイフン入りコード
SetParser -> OrderSheet : 単体数量上書
SetParser -> OrderSheet : 単体コード上書
deactivate SetParser

Main -> SetParser : 7777 セット分解 Sub ParseItems()

activate SetParser

ｾｯﾄ商品ﾘｽﾄ.xls <-- SetParser : 77777xxxxxコード 検索
ｾｯﾄ商品ﾘｽﾄ.xls --> SetParser : 構成商品コレクション

SetParser -> OrderSheet : アイテム行挿入

deactivate SetParser

Main -> ConnectDB : Sub Make_List()
activate ConnectDB
社内DB <- ConnectDB : ロケーション問合せ
社内DB -> ConnectDB :ロケーション取得
OrderSheet <- ConnectDB : ロケーション書込
deactivate ConnectDB



participant DataValidate

Main -> DataValidate : Sub LocationCutter()

activate DataValidate

|||
OrderSheet -> DataValidate :ロケ文字列取得
OrderSheet <- DataValidate :無効ロケ削除
deactivate DataValidate
|||

deactivate DataValidate

participant SheetBuilder

Main -> SheetBuilder : Sub CreatePicking()
activate SheetBuilder

loop 3モール分実行
    
    OrderSheet <-- SheetBuilder : モール別 受注件数チェック

    Group ピッキングデータ作成

        create entity Picking_2_3
        SheetBuilder -> Picking_2_3 : ブック作成

        create entity Picking_a
        SheetBuilder -> Picking_a : ブック作成

        OrderSheet <- SheetBuilder : 受注データ取得

        SheetBuilder --> SheetBuilder : 受注モール判定

        else 棚有り
            SheetBuilder -> Picking_2_3 : 6ケタ振替 データ転記

        else 棚無し
            SheetBuilder -> Picking_a : データ転記
    end

    SheetBuilder -> Picking_2_3 : ファイル保存
    destroy Picking_2_3
    SheetBuilder -> Picking_a : ファイル保存
    deactivate SheetBuilder

    destroy Picking_a
    deactivate SheetBuilder


    Main -> SheetBuilder : Sub CreateForSorterSheet()
        Group 振分シート作成
        activate SheetBuilder
        create entity ForSorter
        SheetBuilder -> ForSorter : シート作成
        create entity ForSorter_set
        SheetBuilder -> ForSorter_set : シート作成
        OrderSheet <-- SheetBuilder : 受注データ取得
        SheetBuilder -> SheetBuilder : 受注モール判定

        else 単体受注品

            SheetBuilder -> ForSorter : 受注データ転記
        
        else セット商品

            SheetBuilder -> ForSorter_set : 受注データ転記
        else

            SheetBuilder -> ForSorter : 商品コードでソート

    end
end

deactivate SheetBuilder

Main --> ForSorter : VBA:PrintOut 
Main --> ForSorter_set : VBA:PrintOut


[<- Main : 終了メッセージ

deactivate Main

@enduml